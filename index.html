<html>
<head>
    <title>PT Photos</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<style>
		body {
			font-family: Helvetica;
		}
		
		#selectors {
			clear: both;
		}
	
		#selectors .selector {
			float: left;
			margin: 10px;
			border: 1px solid #ddd;
			padding: 10px;
			background: #eee;
			font-size: 15px;
			font-weight: bold;
		}
		
		#selectors .selector .count {
			font-size: 11px;
			font-weight: normal;
		}
		
		.tab {
			clear: both;
		}
	
		.tab .album {
			float: left;
			width: 100px;
			margin: 10px;
			overflow: hidden;
		}

		.tab .album img {
			height: 100px;
		}
	
		.tab .picture {
			float: left;
			width: 100px;
			margin: 10px;
			overflow: hidden;
		}

		.tab .picture img {
			height: 100px;
		}
	</style>
	
	<script src="//connect.facebook.net/en_US/all.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
	
	<script src="script/tools.js"></script>
	<script src="script/facebook_connector.js"></script>
	<script src="script/server.js"></script>
	
	<script>
		var environment = {
				facebook_id : '449490838419909',
				server_url  : window.location.protocol + '//tordin.fortis4.com/ptphotos/server/',
				namespace   : 'ptphotos'
			};
			
		environment.facebook_url = window.location.protocol + '//apps.facebook.com/' + environment.namespace;
		
		var page_id = 442893865746848,
			gallery_id = 1;
		
		/* LIKE GATE */
		
		var waiter = new Waiter(2, function(all_done, box) {
			if (all_done && box['user_id']) {
				var likeGate = function(active) {
					$('#like-gate').setVisible(active);
					$('#content').setVisible(!active);
					
					events.fire('content_released');
				};
				
				if (!box['settings'] || !box['settings'].likers_only) {
					likeGate(false);
				} else {
					FB.api({
					    method  : 'pages.isFan',
					    page_id : page_id,
					}, function(response) {
						likeGate(!response);
				    });			
				}
			}
		}, 3000);
		
		events.bind('user_identified', function(event, user_id) {
			waiter.go('user_id', user_id);
		});
			
		server.getPageSettings(gallery_id, function(success, settings) {
			waiter.go('settings', settings);
		});
		
		/* BIND EVENTS */
		
		$(document).ready(function() {
			$('.tab').hide();
			$('#albums').show();
			
			$('.selector').click(function(event) {
				events.fire('tab_selected', $(event.target).closest('.selector').attr('tab'));
			});
		});
		
		/* POPULATE SELECTORS AND TABS */
		
		function renderAlbum(album) {
			var html = $('<div/>');
			
			html.addClass('album')
			.append(
				$('<img/>')
					.attr('src', album.cover_picture_thumb_url)
			).append(
				$('<div/>')
					.html(album.title + '(' + album.picture_count + ')')
			);
			
			return html;
		}
		
		function renderPicture(picture) {
			var html = $('<div/>');
			
			html.addClass('picture')
			.append(
				$('<img/>')
					.attr('src', picture.thumb_url)
			);
			
			return html;
		}
		
		events.bind('content_released', function(event) {
			server.getPicturesCount(gallery_id, function(success, response) {
				if (success) {
					$('.selector[tab=albums] .count').html(response.album_count);
					$('.selector[tab=latest_pictures] .count').html(response.latest_pictures_count);
					
					server.getAlbums(gallery_id, 0, 20, function(success, response) {
						if (success) {
							response.albums.forEach(function(album) {
								$('#albums').append(renderAlbum(album));
							});
						}
					});
					
					server.getLatestPictures(gallery_id, 0, 20, function(success, response) {
						if (success) {
							response.pictures.forEach(function(picture) {
								$('#latest_pictures').append(renderPicture(picture));
							});
						}
					});
					
					server.getMostPopularPictures(gallery_id, 0, 20, function(success, response) {
						if (success) {
							response.pictures.forEach(function(picture) {
								$('#most_popular').append(renderPicture(picture));
							});
						}
					});
				}
			});
		});
		
		/* EVENTS */
		
		events.bind('tab_selected', function(event, tab) {
			$('.tab').hide();
			$('#' + tab).show();
		});
	</script>
</head>
<body>
	<div id="fb-root"></div>
	<h1>PT Photos</h1>
	<div id="like-gate" style="display: none;">LIKE THIS PAGE TO GET ACCESS</div>
	<div id="content" style="display: none;">
		<div id="selectors">
			<div class="selector" tab="albums">Albums<div class="count"></div></div>
			<div class="selector" tab="latest_pictures">Latest pictures<div class="count"></div></div>
			<div class="selector" tab="most_popular">Most popular<div class="count"></div></div>
		</div>
		<div id="albums" class="tab"></div>
		<div id="latest_pictures" class="tab"></div>
		<div id="most_popular" class="tab"></div>
	</div>
</body>
</html>